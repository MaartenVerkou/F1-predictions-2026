<%- include('partials/header', { title: t('leaderboard.page_title'), user }) %>

<div class="card">
  <% const formatAnswer = (question, raw) => {
    if (raw == null || raw === "") return "-";
    const text = String(raw);
    const type = question?.type || "text";
    if (
      type === "ranking" ||
      type === "multi_select" ||
      type === "multi_select_limited" ||
      type === "teammate_battle" ||
      type === "boolean_with_optional_driver" ||
      type === "numeric_with_driver" ||
      type === "single_choice_with_driver"
    ) {
      try {
        const parsed = JSON.parse(text);
        if (Array.isArray(parsed)) return parsed.join(" | ");
        if (parsed && typeof parsed === "object") {
          if (type === "teammate_battle") {
            if (parsed.winner === "tie") return "Tie";
            if (parsed.winner) {
              const diffText =
                parsed.diff == null || parsed.diff === ""
                  ? ""
                  : ` (${parsed.diff})`;
              return `${parsed.winner}${diffText}`;
            }
          }
          if (type === "boolean_with_optional_driver") {
            const choice = parsed.choice == null ? "-" : String(parsed.choice);
            return parsed.driver ? `${choice} - ${parsed.driver}` : choice;
          }
          if (type === "numeric_with_driver" || type === "single_choice_with_driver") {
            const value = parsed.value == null ? "-" : String(parsed.value);
            return parsed.driver ? `${value} - ${parsed.driver}` : value;
          }
          return Object.entries(parsed)
            .map(([key, value]) => `${key}: ${value == null ? "-" : value}`)
            .join("; ");
        }
        return parsed == null ? "-" : String(parsed);
      } catch (err) {
        return text;
      }
    }
    return text;
  }; %>
  <% const leaderboardBaseHref =
    typeof leaderboardBasePath === "string" && leaderboardBasePath
      ? leaderboardBasePath
      : `/groups/${group.id}/leaderboard`; %>
  <% const leaderboardQueryPart =
    typeof leaderboardQuery === "string" && leaderboardQuery.trim()
      ? leaderboardQuery.trim()
      : ""; %>
  <% const pageHref = (pageNumber) =>
    leaderboardQueryPart
      ? `${leaderboardBaseHref}?${leaderboardQueryPart}&page=${pageNumber}#leaderboard-details`
      : `${leaderboardBaseHref}?page=${pageNumber}#leaderboard-details`; %>

  <h1><%= group.name %>: <%= t('leaderboard.page_title') %></h1>
  <p class="muted"><%= t('leaderboard.subtitle') %></p>

  <% if (Object.keys(actuals || {}).length === 0) { %>
    <div class="alert"><%= t('leaderboard.no_actuals') %></div>
  <% } %>

  <% if (leaderboard.length === 0) { %>
    <div class="alert"><%= t('leaderboard.no_scored_responses') %></div>
  <% } else { %>
    <p class="muted">
      <% const startRank = (currentLeaderboardPage - 1) * leaderboardPerPage + 1; %>
      <% const endRank = startRank + leaderboard.length - 1; %>
      Showing <%= startRank %>-<%= endRank %> of <%= leaderboardTotal %>
    </p>

    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th><%= t('leaderboard.member') %></th>
          <th><%= t('leaderboard.total_points') %></th>
        </tr>
      </thead>
      <tbody>
        <% leaderboard.forEach(row => { %>
          <tr>
            <td><%= row.rank %></td>
            <td><%= row.name %></td>
            <td><strong><%= row.total %></strong></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
    <div class="inline-actions" style="margin-top: 10px;">
      <% if (currentLeaderboardPage > 1) { %>
        <a class="link" href="<%= pageHref(currentLeaderboardPage - 1) %>">Previous <%= leaderboardPerPage %></a>
      <% } %>
      <span class="muted">Page <%= currentLeaderboardPage %> of <%= totalLeaderboardPages %></span>
      <% if (currentLeaderboardPage < totalLeaderboardPages) { %>
        <a class="link" href="<%= pageHref(currentLeaderboardPage + 1) %>">Next <%= leaderboardPerPage %></a>
      <% } %>
    </div>

    <h2 id="leaderboard-details" style="margin-top:24px;"><%= t('leaderboard.details') %></h2>
    <div class="leaderboard-member-switcher" data-member-switcher>
      <button
        type="button"
        class="secondary leaderboard-strip-arrow"
        data-member-scroll="prev"
        aria-label="Scroll members left"
      >
        &#8249;
      </button>

      <div class="leaderboard-member-strip" data-member-strip role="tablist" aria-label="Members">
        <% leaderboard.forEach((row, index) => { %>
          <% const panelId = `leaderboard-member-panel-${row.userId}`; %>
          <% const tabId = `leaderboard-member-tab-${row.userId}`; %>
          <button
            type="button"
            id="<%= tabId %>"
            role="tab"
            aria-controls="<%= panelId %>"
            aria-selected="<%= index === 0 ? 'true' : 'false' %>"
            tabindex="<%= index === 0 ? '0' : '-1' %>"
            class="leaderboard-member-tab <%= index === 0 ? 'is-active' : '' %>"
            data-member-tab
            data-target="<%= panelId %>"
          >
            <span class="leaderboard-member-rank">#<%= row.rank %></span>
            <span><%= row.name %></span>
          </button>
        <% }) %>
      </div>

      <button
        type="button"
        class="secondary leaderboard-strip-arrow"
        data-member-scroll="next"
        aria-label="Scroll members right"
      >
        &#8250;
      </button>
    </div>

    <% leaderboard.forEach((row, index) => { %>
      <% const panelId = `leaderboard-member-panel-${row.userId}`; %>
      <% const tabId = `leaderboard-member-tab-${row.userId}`; %>
      <section
        id="<%= panelId %>"
        role="tabpanel"
        aria-labelledby="<%= tabId %>"
        class="card leaderboard-member-panel <%= index === 0 ? 'is-active' : '' %>"
        <%= index === 0 ? '' : 'hidden' %>
      >
        <div class="leaderboard-member-heading">
          <strong><%= row.name %></strong>
          <span class="muted"><%= row.total %> <%= t('leaderboard.points_short') %></span>
        </div>
        <table class="table compact" style="margin-top:8px;">
          <thead>
            <tr>
              <th>Question</th>
              <th>Answer</th>
              <th>Points</th>
            </tr>
          </thead>
          <tbody>
          <% questions.forEach(q => { %>
            <tr>
              <td><%= q.prompt %></td>
              <td><%= formatAnswer(q, row.answersByQuestion?.[q.id]) %></td>
              <td><%= row.byQuestion[q.id] ?? 0 %> <%= t('leaderboard.points_short') %></td>
            </tr>
          <% }) %>
          </tbody>
        </table>
      </section>
    <% }) %>
  <% } %>
</div>

<%- include('partials/footer') %>
