<%- include('partials/header', { title: t('questions.page_title'), user }) %>

<div class="card">
  <% const currentGroupPath = (typeof groupBasePath === 'string' && groupBasePath) ? groupBasePath : groupPath(group); %>
  <h1><%= group.name %>: <%= t('questions.page_title') %></h1>
  <div class="page-title-actions">
    <a class="button-link" href="<%= currentGroupPath %>"><%= t('group.back_to_group') %></a>
  </div>
  <div class="group-rules-box">
    <div class="group-rules-label"><%= t('group.rules_label') %></div>
    <p class="muted group-rules-text"><%= groupRules %></p>
  </div>

  <% if (closed) { %>
    <div class="alert"><%= t('questions.closed_message') %></div>
  <% } %>

  <div class="questions-top-actions">
    <% if (copyGroups && copyGroups.length > 0 && !(canCoupleToGlobal && coupledToGlobal)) { %>
      <form method="get" action="<%= `${currentGroupPath}/questions` %>" class="inline-actions">
        <label class="muted" style="display:flex; align-items:center; gap:8px; font-weight:600;">
          <%= t('questions.copy_from') %>
          <select name="copyFrom" onchange="this.form.submit()">
            <option value=""><%= t('questions.select_group') %></option>
            <% copyGroups.forEach(copyGroup => { %>
              <option value="<%= copyGroup.id %>" <%= selectedCopyGroupId === copyGroup.id ? 'selected' : '' %>>
                <%= copyGroup.name %><%= copyGroup.is_global ? ` (${t('questions.global_tag')})` : '' %>
              </option>
            <% }) %>
          </select>
        </label>
        <% if (selectedCopyGroupId) { %>
          <a class="link underlined-link" href="<%= `${currentGroupPath}/questions` %>"><%= t('questions.reset') %></a>
          <button type="submit" form="predictions-form" class="link underlined-link link-button" <%= closed ? 'disabled' : '' %>><%= t('questions.save') %></button>
        <% } %>
      </form>
    <% } %>
  </div>

  <% if (prefillNotice) { %>
    <p class="muted" style="margin:0 0 14px;"><%= prefillNotice %></p>
  <% } %>

  <form id="predictions-form" method="post" action="<%= `${currentGroupPath}/questions` %>">
    <% if (canCoupleToGlobal) { %>
      <div class="questions-couple-toggle">
        <label class="muted" style="display:inline-flex; align-items:center; gap:8px; font-weight:600;">
          <input
            type="checkbox"
            name="coupleToGlobal"
            value="1"
            data-couple-toggle
            <%= coupledToGlobal ? 'checked' : '' %>
            <%= closed ? 'disabled' : '' %>
          />
          <%= t('questions.couple_to_global_label', { group_name: globalGroupName }) %>
        </label>
        <div class="muted"><%= t('questions.couple_to_global_help') %></div>
      </div>
    <% } %>

    <fieldset class="questions-fields" data-coupled-fields <%= canCoupleToGlobal && coupledToGlobal ? 'disabled' : '' %>>
      <% if (questions.length === 0) { %>
        <div class="alert"><%= t('questions.no_questions') %></div>
      <% } %>

      <% const formatPoints = (q) => {
        if (q.type === 'multi_select' && typeof q.points === 'number' && typeof q.penalty === 'number' && typeof q.minimum === 'number') {
          return t('questions.points_multi_select_penalty', {
            points: q.points,
            penalty: q.penalty,
            minimum: q.minimum,
            points_word: t('questions.points_word'),
            driver_word: t('questions.driver_word')
          });
        }
        if (q.type === 'teammate_battle' && typeof q.points === 'number') {
          return t('questions.points_teammate_battle', {
            base: q.points,
            tie_bonus: Number(q.tie_bonus || 0),
            points_word: t('questions.points_word')
          });
        }
        if (q.special_case === 'all_podiums_bonus' && typeof q.points === 'number' && typeof q.bonus_points === 'number') {
          return t('questions.points_all_podiums_bonus', {
            base: q.points,
            bonus: q.bonus_points,
            points_word: t('questions.points_word')
          });
        }
        if (q.type === 'multi_select_limited' && q.options_source === 'races' && typeof q.points === 'number') {
          return t('questions.points_per_dnf_selected_races', {
            points: q.points,
            points_word: t('questions.points_word')
          });
        }
        if (q.points_display) {
          const simplePoints = String(q.points_display).trim().match(/^(\d+)\s+points?$/i);
          if (simplePoints) {
            return `${simplePoints[1]} ${t('questions.points_word')}`;
          }
          return q.points_display;
        }
        if (q.points == null) return null;
        if (typeof q.points === 'number') return `${q.points} ${t('questions.points_word')}`;
        if (typeof q.points === 'string') return q.points;
        if (q.points.position || q.points.driver) {
          return `${t('questions.points_label')}: ${t('questions.position_word')} ${q.points.position || 0}, ${t('questions.driver_word')} ${q.points.driver || 0}`;
        }
        const entries = Object.entries(q.points).map(([key, value]) => `${key}: ${value}`);
        return entries.length ? `${t('questions.points_label')}: ${entries.join(', ')}` : null;
      }; %>
      <% const isHumanReadableSourceUrl = (url) => {
        if (!url || typeof url !== 'string') return false;
        const value = url.trim();
        if (!/^https?:\/\//i.test(value)) return false;
        const lower = value.toLowerCase();
        if (lower.includes('api.jolpi.ca')) return false;
        if (lower.includes('/ergast/')) return false;
        if (lower.endsWith('.json') || lower.includes('.json?')) return false;
        return true;
      }; %>

      <% questions.forEach(question => { 
        const sourceOptions = question.options_source === 'drivers'
          ? roster.drivers
          : question.options_source === 'teams'
            ? roster.teams
            : question.options_source === 'races'
              ? races
              : [];
        const options = (question.options || []).concat(sourceOptions || []);
        const optionLabels = question.option_labels || {};
        const getOptionLabel = (option) => optionLabels[option] || option;
        const type = question.type || 'text';
        const lastSeason = question.last_season || null;
        const hasLastSeasonReference = Boolean(lastSeason);
        const lastSeasonResult = hasLastSeasonReference
          ? (String(lastSeason?.result || '').trim() || t('questions.last_season_default_result'))
          : '';
        const lastSeasonUrl = String(lastSeason?.url || '').trim();
        const lastSeasonLabel = String(lastSeason?.label || '').trim();
        const lastSeasonSourceUrl = isHumanReadableSourceUrl(lastSeasonUrl) ? lastSeasonUrl : '';
        const hasLastSeasonDetails = hasLastSeasonReference && Boolean(lastSeasonResult || lastSeasonSourceUrl);
      %>
        <div class="question">
          <div class="question-head-row">
            <div class="question-title"><%= question.prompt %></div>
          </div>
          <% if (question.helper) { %>
            <div class="muted"><%= question.helper %></div>
          <% } %>
          <% const pointsText = formatPoints(question); %>
          <% if (pointsText || hasLastSeasonDetails) { %>
            <div class="question-meta-row <%= !pointsText ? 'is-last-season-only' : '' %>">
              <% if (pointsText) { %>
                <div class="muted question-points"><%= pointsText %></div>
              <% } %>
              <% if (hasLastSeasonDetails) { %>
                <div class="question-last-season-peek" tabindex="0">
                  <span class="question-last-season-toggle"><%= t('questions.last_season_link') %></span>
                  <div class="question-last-season-panel">
                    <% if (lastSeasonResult) { %>
                      <div class="question-last-season-result"><%= lastSeasonResult %></div>
                    <% } %>
                    <% if (lastSeasonSourceUrl) { %>
                      <a
                        class="link question-last-season-source"
                        href="<%= lastSeasonSourceUrl %>"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        <%= lastSeasonLabel || lastSeasonSourceUrl %>
                      </a>
                    <% } %>
                  </div>
                </div>
              <% } %>
            </div>
          <% } %>
          <% if ((type === 'ranking' || type === 'single_choice' || type === 'multi_select' || type === 'multi_select_limited') && (!options || options.length === 0)) { %>
            <div class="alert"><%= t('questions.no_options_loaded') %></div>
          <% } %>
          <% if (type === 'ranking') { 
            const count = Number(question.count) || 3;
            let saved = [];
            try { saved = JSON.parse(answers[question.id] || '[]'); } catch (err) { saved = []; }
          %>
            <div class="ranking-group" data-count="<%= count %>">
              <% for (let i = 1; i <= count; i += 1) { %>
                <select class="ranking-select" name="<%= question.id %>_<%= i %>">
                  <option value=""><%= t('questions.select_position') %> <%= i %></option>
                  <% options.forEach(option => { %>
                    <option value="<%= option %>" <%= saved[i - 1] === option ? 'selected' : '' %>><%= getOptionLabel(option) %></option>
                  <% }) %>
                </select>
              <% } %>
            </div>
          <% } else if (type === 'single_choice') { %>
            <select name="<%= question.id %>">
              <option value=""><%= t('questions.select_one') %></option>
              <% options.forEach(option => { %>
                <option value="<%= option %>" <%= answers[question.id] === option ? 'selected' : '' %>><%= getOptionLabel(option) %></option>
              <% }) %>
            </select>
          <% } else if (type === 'multi_select' || type === 'multi_select_limited') { 
            let saved = [];
            try { saved = JSON.parse(answers[question.id] || '[]'); } catch (err) { saved = []; }
            const limit = type === 'multi_select_limited' ? (Number(question.count) || 0) : 0;
          %>
          <div class="checkbox-grid" data-limit="<%= limit %>">
            <% options.forEach(option => { %>
              <label class="muted">
                <input type="checkbox" name="<%= question.id %>" value="<%= option %>" <%= saved.includes(option) ? 'checked' : '' %> />
                <%= getOptionLabel(option) %>
              </label>
            <% }) %>
          </div>
        <% } else if (type === 'teammate_battle') { 
            let saved = {};
            try { saved = JSON.parse(answers[question.id] || '{}'); } catch (err) { saved = {}; }
          %>
            <div class="inline-actions">
              <select name="<%= question.id %>_winner" data-toggle-diff="<%= question.id %>">
                <option value=""><%= t('questions.select_winner') %></option>
                <% (question.options || []).forEach(option => { %>
                  <option value="<%= option %>" <%= saved.winner === option ? 'selected' : '' %>><%= getOptionLabel(option) %></option>
                <% }) %>
                <option value="tie" <%= saved.winner === 'tie' ? 'selected' : '' %>><%= t('questions.tie') %></option>
              </select>
              <input type="number" name="<%= question.id %>_diff" data-diff-for="<%= question.id %>" placeholder="<%= t('questions.points_diff') %>" min="0" max="999" value="<%= saved.diff ?? '' %>" />
            </div>
          <% } else if (type === 'boolean_with_optional_driver') { 
            let saved = {};
            try { saved = JSON.parse(answers[question.id] || '{}'); } catch (err) { saved = {}; }
          %>
            <div class="inline-actions">
              <label class="muted">
                <input type="radio" name="<%= question.id %>" value="yes" <%= saved.choice === 'yes' ? 'checked' : '' %> />
                <%= t('questions.yes') %>
              </label>
              <label class="muted">
                <input type="radio" name="<%= question.id %>" value="no" <%= saved.choice === 'no' ? 'checked' : '' %> />
                <%= t('questions.no') %>
              </label>
              <select name="<%= question.id %>_driver" data-toggle-driver="<%= question.id %>">
                <option value=""><%= t('questions.select_driver_if_yes') %></option>
                <% roster.drivers.forEach(option => { %>
                  <option value="<%= option %>" <%= saved.driver === option ? 'selected' : '' %>><%= option %></option>
                <% }) %>
              </select>
            </div>
          <% } else if (type === 'numeric_with_driver') { 
            let saved = {};
            try { saved = JSON.parse(answers[question.id] || '{}'); } catch (err) { saved = {}; }
          %>
            <div class="inline-actions">
              <input type="number" name="<%= question.id %>_value" placeholder="<%= t('questions.number') %>" min="0" max="999" value="<%= saved.value ?? '' %>" />
              <select name="<%= question.id %>_driver">
                <option value=""><%= t('questions.select_driver') %></option>
                <% roster.drivers.forEach(option => { %>
                  <option value="<%= option %>" <%= saved.driver === option ? 'selected' : '' %>><%= option %></option>
                <% }) %>
              </select>
            </div>
          <% } else if (type === 'single_choice_with_driver') { 
            let saved = {};
            try { saved = JSON.parse(answers[question.id] || '{}'); } catch (err) { saved = {}; }
            const driverOptions = roster.drivers;
            const positionOptions = question.options || [];
          %>
            <div class="inline-actions">
              <select name="<%= question.id %>_value">
                <option value=""><%= t('questions.select_position') %></option>
                <% positionOptions.forEach(option => { %>
                  <option value="<%= option %>" <%= saved.value === option ? 'selected' : '' %>><%= getOptionLabel(option) %></option>
                <% }) %>
              </select>
              <select name="<%= question.id %>_driver">
                <option value=""><%= t('questions.select_driver') %></option>
                <% driverOptions.forEach(option => { %>
                  <option value="<%= option %>" <%= saved.driver === option ? 'selected' : '' %>><%= option %></option>
                <% }) %>
              </select>
            </div>
          <% } else if (type === 'boolean') { %>
            <div class="inline-actions">
              <label class="muted">
                <input type="radio" name="<%= question.id %>" value="yes" <%= answers[question.id] === 'yes' ? 'checked' : '' %> />
                <%= t('questions.yes') %>
              </label>
              <label class="muted">
                <input type="radio" name="<%= question.id %>" value="no" <%= answers[question.id] === 'no' ? 'checked' : '' %> />
                <%= t('questions.no') %>
              </label>
            </div>
          <% } else if (type === 'numeric') { %>
            <input type="number" name="<%= question.id %>" min="0" max="999" value="<%= answers[question.id] || '' %>" />
          <% } else if (type === 'textarea') { %>
            <textarea name="<%= question.id %>" rows="3"><%= answers[question.id] || '' %></textarea>
          <% } else { %>
            <input type="text" name="<%= question.id %>" value="<%= answers[question.id] || '' %>" />
          <% } %>
        </div>
      <% }) %>
    </fieldset>

    <div class="questions-save-row">
      <button type="submit" data-predictions-save-button <%= closed ? 'disabled' : '' %>><%= t('questions.save_predictions') %></button>
      <span
        class="muted questions-autosave-status"
        data-autosave-status
        data-status-unsaved="<%= t('questions.autosave_unsaved') %>"
        data-status-saving="<%= t('questions.autosave_saving') %>"
        data-status-saved="<%= t('questions.autosave_saved') %>"
        data-status-failed="<%= t('questions.autosave_failed') %>"
        aria-live="polite"
      ></span>
    </div>
    <div id="questions-form-end"></div>
  </form>
</div>

<button
  type="button"
  class="scroll-to-end-btn is-hidden"
  data-scroll-to-end
  data-scroll-to-end-target="#questions-form-end"
  aria-label="<%= t('questions.scroll_to_end') %>"
  title="<%= t('questions.scroll_to_end') %>"
>
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"></path>
  </svg>
</button>

<%- include('partials/footer') %>

